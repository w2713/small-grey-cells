{% extends "layout.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Мои заметки</h1>
        <a href="{{ url_for('main.create_note') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Создать заметку
        </a>
    </div>

    {% if not notes %}
    <div class="alert alert-info">
        У вас пока нет заметок. Начните с создания новой заметки!
    </div>
    {% endif %}

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="notes-container">
        {% for note in notes %}
        <div class="col">
            <div class="card h-100 note-card" data-id="{{ note._id }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h5 class="card-title mb-3">{{ note.title }}</h5>
                        <button class="btn btn-sm btn-outline-danger delete-note" data-id="{{ note._id }}">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>

                    <!-- Контент с поддержкой форматирования -->
                    <div class="card-text mb-3 note-content" style="max-height: 200px; overflow: hidden;">
                        {{ note.content | safe }}
                    </div>

                    <!-- Вложения -->
                    {% if note.attachments %}
                    <div class="attachments mb-3">
                        {% for attachment in note.attachments %}
                            {% if attachment.type == 'image' %}
                            <img src="{{ attachment.url }}" class="img-thumbnail mb-2" style="max-width: 100px;">
                            {% elif attachment.type == 'video' %}
                            <video controls class="mb-2" style="max-width: 100%;">
                                <source src="{{ attachment.url }}" type="video/mp4">
                            </video>
                            {% elif attachment.type == 'audio' %}
                            <audio controls class="mb-2" style="width: 100%;">
                                <source src="{{ attachment.url }}" type="audio/mpeg">
                            </audio>
                            {% else %}
                            <a href="{{ attachment.url }}" class="d-block mb-1" target="_blank">
                                <i class="bi bi-file-earmark"></i> {{ attachment.name }}
                            </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Теги -->
                    <div class="d-flex flex-wrap gap-1 mb-3">
                        {% for tag in note.tags %}
                        <span class="badge bg-secondary">{{ tag }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="card-footer bg-transparent border-top-0 d-flex justify-content-between">
                    <small class="text-muted">
                        <i class="bi bi-calendar me-1"></i>
                        {{ note.updated_at.strftime('%d.%m.%Y %H:%M') }}
                    </small>
                    <small class="text-muted">
                        <i class="bi bi-clock-history me-1"></i>
                        {{ note.created_at.strftime('%d.%m.%Y') }}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Модальное окно для редактирования -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">Редактирование заметки</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="loadingIndicator" class="d-none text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3">Загрузка заметки...</p>
                </div>

                <div id="noteFormContainer">
                    <form id="noteForm">
                        <input type="hidden" id="note_id" name="note_id">
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">Заголовок *</label>
                            <input type="text" class="form-control form-control-lg" id="title" name="title" required>
                        </div>

                        <!-- Панель форматирования -->
                        <div class="mb-3 d-flex flex-wrap gap-1" id="formattingToolbar">
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-format="bold" title="Жирный">
                                <i class="bi bi-type-bold"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-format="italic" title="Курсив">
                                <i class="bi bi-type-italic"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-format="underline" title="Подчеркнутый">
                                <i class="bi bi-type-underline"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-format="strikethrough" title="Зачеркнутый">
                                <i class="bi bi-type-strikethrough"></i>
                            </button>

                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Списки">
                                    <i class="bi bi-list-ul"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><button type="button" class="dropdown-item" data-format="insertUnorderedList">Маркированный список</button></li>
                                    <li><button type="button" class="dropdown-item" data-format="insertOrderedList">Нумерованный список</button></li>
                                </ul>
                            </div>

                            <button type="button" class="btn btn-sm btn-outline-secondary" data-format="formatBlock" data-value="blockquote" title="Цитата">
                                <i class="bi bi-blockquote-left"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-format="formatBlock" data-value="pre" title="Блок кода">
                                <i class="bi bi-code-slash"></i>
                            </button>

                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Вставить">
                                    <i class="bi bi-paperclip"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><button type="button" class="dropdown-item" data-insert="image">Изображение</button></li>
                                    <li><button type="button" class="dropdown-item" data-insert="video">Видео</button></li>
                                    <li><button type="button" class="dropdown-item" data-insert="audio">Аудио</button></li>
                                    <li><button type="button" class="dropdown-item" data-insert="file">Файл</button></li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">Содержание *</label>
                            <div id="editor" class="border p-3 bg-white" style="min-height: 300px; max-height: 50vh; overflow-y: auto;" contenteditable="true"></div>
                            <textarea class="form-control d-none" id="content" name="content" rows="15" required></textarea>
                        </div>

                        <!-- Превью вложений -->
                        <div class="mb-4" id="attachmentsPreview"></div>

                        <!-- Загрузка новых вложений -->
                        <div class="mb-4">
                            <label for="newAttachments" class="form-label fw-bold">Добавить вложения</label>
                            <input type="file" class="form-control" id="newAttachments" name="newAttachments" multiple>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-4">
                                <label for="tags" class="form-label fw-bold">Теги</label>
                                <select class="form-select" id="tags" name="tags" multiple size="5">
                                    {% for tag in all_tags %}
                                    <option value="{{ tag }}">{{ tag }}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Удерживайте Ctrl (Cmd на Mac) для выбора нескольких тегов</small>
                            </div>
                            <div class="col-md-6 mb-4">
                                <label for="category" class="form-label fw-bold">Категория</label>
                                <input type="text" class="form-control" id="category" name="category">
                                <div class="mt-3">
                                    <label class="form-label fw-bold">Дата создания</label>
                                    <div class="form-control-plaintext" id="createdAt"></div>
                                </div>
                                <div class="mt-2">
                                    <label class="form-label fw-bold">Последнее изменение</label>
                                    <div class="form-control-plaintext" id="updatedAt"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div id="errorContainer" class="d-none alert alert-danger"></div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg me-1"></i> Закрыть
                </button>
                <button type="button" class="btn btn-primary" id="saveNoteBtn">
                    <i class="bi bi-save me-1"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.1/purify.min.js"></script>

<script>

</script>

{% endblock %}